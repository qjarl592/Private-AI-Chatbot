# .github/workflows/update-readme.yml
name: AI README Updater

on:
  issue_comment:
    types: [created]

jobs:
  update-readme:
    if: |
      github.event.issue.pull_request != null &&
      startsWith(github.event.comment.body, '/update-readme')

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 추가 지시사항 파싱
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          INSTRUCTION="${COMMENT#/update-readme}"
          INSTRUCTION="${INSTRUCTION#"${INSTRUCTION%%[! ]*}"}"
          echo "instruction=$INSTRUCTION" >> $GITHUB_OUTPUT

          if [ -z "$INSTRUCTION" ]; then
            echo "mode=initial" >> $GITHUB_OUTPUT
          else
            echo "mode=refine" >> $GITHUB_OUTPUT
          fi

      - name: 시작 코멘트
        id: start_comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⏳ README 업데이트 중입니다...'
            });
            core.setOutput('comment_id', comment.data.id);

      - name: PR 브랜치 체크아웃
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.issue.pull_request.head.ref }}
          repository: ${{ github.event.issue.pull_request.head.repo.full_name }}

      - name: Python 설치
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 의존성 설치
        run: pip install google-genai

      - name: 시스템 프롬프트 확인
        run: |
          if [ ! -f ".github/workflows/ai-readme-updater-prompt.md" ]; then
            echo "❌ .github/workflows/ai-readme-updater-prompt.md 파일이 없습니다."
            exit 1
          fi
          echo "시스템 프롬프트 로드 완료"

      # -------------------------------------------------------
      # [initial 모드] diff 수집
      # -------------------------------------------------------
      - name: README 마지막 수정 커밋 ~ 현재 diff 수집
        if: steps.parse.outputs.mode == 'initial'
        id: collect_diff
        run: |
          LAST_README_COMMIT=$(git log -1 --pretty=format:"%H" -- README.md)
          echo "last_readme_commit=$LAST_README_COMMIT" >> $GITHUB_OUTPUT

          if [ -z "$LAST_README_COMMIT" ]; then
            git diff HEAD -- . ':(exclude)README.md' > /tmp/code_diff.txt
          else
            git diff $LAST_README_COMMIT HEAD -- . ':(exclude)README.md' > /tmp/code_diff.txt
          fi

          if [ ! -s /tmp/code_diff.txt ]; then
            echo "has_diff=false" >> $GITHUB_OUTPUT
          else
            echo "has_diff=true" >> $GITHUB_OUTPUT
            truncate -s 100k /tmp/code_diff.txt
          fi

      # -------------------------------------------------------
      # [initial 모드] Gemini 3 Flash - diff 기반 업데이트
      # -------------------------------------------------------
      - name: "[Initial] Gemini로 README 업데이트"
        if: |
          steps.parse.outputs.mode == 'initial' &&
          steps.collect_diff.outputs.has_diff == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 << 'PYTHON'
          import os
          from google import genai
          from google.genai import types

          client = genai.Client(api_key=os.environ["GEMINI_API_KEY"])

          system_prompt = open(".github/workflows/ai-readme-updater-prompt.md").read()
          current_readme = open("README.md").read()
          code_diff = open("/tmp/code_diff.txt").read()

          prompt = f"""아래 정보를 바탕으로 README.md를 업데이트해주세요.

          ## 현재 README.md
          {current_readme}

          ## README 마지막 업데이트 이후 코드 변경사항 (git diff)
          {code_diff}

          ## 지시사항
          - 코드 변경사항을 분석해서 README에 반영이 필요한 부분만 업데이트하세요.
          - 변경사항과 관련 없는 섹션은 절대 수정하지 마세요.
          - 업데이트가 필요 없다고 판단되면 기존 README를 그대로 출력하세요.
          """

          response = client.models.generate_content(
              model="gemini-3-flash-preview",
              contents=prompt,
              config=types.GenerateContentConfig(
                  system_instruction=system_prompt,
              )
          )

          with open("README.md", "w") as f:
              f.write(response.text)
          print("README 업데이트 완료")
          PYTHON

      # -------------------------------------------------------
      # [refine 모드] Gemini 3 Flash - 추가 지시사항 반영
      # -------------------------------------------------------
      - name: "[Refine] Gemini로 README 수정"
        if: steps.parse.outputs.mode == 'refine'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          INSTRUCTION: ${{ steps.parse.outputs.instruction }}
        run: |
          python3 << 'PYTHON'
          import os
          from google import genai
          from google.genai import types

          client = genai.Client(api_key=os.environ["GEMINI_API_KEY"])

          system_prompt = open(".github/workflows/ai-readme-updater-prompt.md").read()
          current_readme = open("README.md").read()
          instruction = os.environ["INSTRUCTION"]

          prompt = f"""아래 README.md를 사용자의 지시사항에 따라 수정해주세요.

          ## 현재 README.md
          {current_readme}

          ## 사용자 지시사항
          {instruction}

          지시사항에 해당하는 부분만 수정하고 나머지는 그대로 유지하세요.
          """

          response = client.models.generate_content(
              model="gemini-3-flash-preview",
              contents=prompt,
              config=types.GenerateContentConfig(
                  system_instruction=system_prompt,
              )
          )

          with open("README.md", "w") as f:
              f.write(response.text)
          print("README 수정 완료")
          PYTHON

      # -------------------------------------------------------
      # 커밋 & 푸시 (두 모드 공통)
      # -------------------------------------------------------
      - name: 변경사항 커밋 & 푸시
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md

          if git diff --staged --quiet; then
            echo "committed=false" >> $GITHUB_OUTPUT
          else
            MODE="${{ steps.parse.outputs.mode }}"
            INSTRUCTION="${{ steps.parse.outputs.instruction }}"
            if [ "$MODE" = "refine" ]; then
              git commit -m "docs: AI README 수정 - $INSTRUCTION [skip ci]"
            else
              git commit -m "docs: AI README 업데이트 [skip ci]"
            fi
            PR_BRANCH="${{ github.event.issue.pull_request.head.ref }}"
            git push origin HEAD:$PR_BRANCH
            echo "committed=true" >> $GITHUB_OUTPUT
          fi

      # -------------------------------------------------------
      # 결과 코멘트 (시작 코멘트 수정)
      # -------------------------------------------------------
      - name: 결과 코멘트
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const committed = '${{ steps.commit.outputs.committed }}';
            const mode = '${{ steps.parse.outputs.mode }}';
            const hasDiff = '${{ steps.collect_diff.outputs.has_diff }}';
            const commentId = ${{ steps.start_comment.outputs.comment_id }};

            let message = '';
            if (mode === 'initial' && hasDiff === 'false') {
              message = '✅ README 마지막 업데이트 이후 코드 변경사항이 없어 업데이트가 필요하지 않습니다.';
            } else if (committed === 'true') {
              message = mode === 'refine'
                ? `✅ 지시사항을 반영해서 README를 수정했습니다.\n\n추가 수정이 필요하면 \`/update-readme <지시사항>\` 으로 알려주세요.`
                : `✅ README를 업데이트했습니다.\n\n수정이 필요하면 \`/update-readme <지시사항>\` 으로 알려주세요.\n예) \`/update-readme 설치 방법 섹션을 더 자세하게 작성해줘\``;
            } else if (committed === 'false') {
              message = mode === 'refine'
                ? `ℹ️ 지시사항을 검토했지만 변경할 내용이 없다고 판단했습니다.`
                : `ℹ️ 코드 변경사항이 있지만 README에 반영할 내용이 없다고 판단했습니다.`;
            } else {
              message = '❌ 워크플로우 실행 중 오류가 발생했습니다. Actions 로그를 확인해주세요.';
            }

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: message
            });